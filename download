#!/usr/bin/env bash

set -euo pipefail

here="$(dirname "$0")"

mkdir -p result .cache

fetch_cache() {
  while read date; do
    cache=".cache/$(echo $date | tr '/' '_')"
    if ! [[ -f "$cache" ]]; then
      echo "Downloading $cache" >&2
      "$here"/scripts/fetch $date 2>/dev/null > "$cache"
    fi
    echo "$cache"
  done	
}

parse_html() {
  while read html; do
    out="$(echo "$html" | sed -s 's/^\.cache/result/')"
    cat "$html" | "$here"/scripts/parse > "$out"
  done	
}

"$here"/scripts/missing-dates | fetch_cache | parse_html
